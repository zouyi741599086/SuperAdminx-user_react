tinymce.PluginManager.add('axupimgs', function(editor, url) {
	var pluginName='多图片上传';
	window.axupimgs={}; // 扔外部公共变量，也可以扔一个自定义的位置

	var baseURL=tinymce.baseURL;
	
	var iframe1 = `${import.meta.env.BASE_URL}tinymce/plugins/axupimgs/upfiles.html`;
    axupimgs.images_upload_handler = editor.getParam('images_upload_imgs', undefined, 'function');
    axupimgs.images_upload_base_path = editor.getParam('images_upload_base_path', '', 'string');
    axupimgs.axupimgs_filetype = editor.getParam('axupimgs_filetype', '.png,.gif,.jpg,.jpeg', 'string');
	axupimgs.res=[];
	var openDialog = function() {
		return editor.windowManager.openUrl({
			title: pluginName,
			size: 'large',
			url:iframe1,
			buttons: [
				{
					type: 'cancel',
					text: 'Close'
				},
				{
					type: 'custom',
					text: 'Save',
					name: 'save',
					primary: true
				},
			],
			onAction: function (api, details) {
				switch (details.name) {
					case 'save':
						var html = '';
						var imgs = axupimgs.res;
						var len = imgs.length;
						for(let i=0;i<len;i++){
							if( imgs[i].url ){
								html += '<img src="'+imgs[i].url+'" />';
							}
						}
						editor.insertContent(html);
						axupimgs.res=[];
						api.close();
						break;
					default:
						break;
				}
				
			}
		});
	};

	editor.ui.registry.getAll().icons.axupimgs || editor.ui.registry.addIcon('axupimgs','<svg t="1677821446167" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1427" width="21" height="21"><path d="M794.02810785 243.92701472h-721.44617876a63.0569592 63.0569592 0 0 0-62.97928692 62.97928691v0.28479842l2.00653433 323.1038072a46.60337778 46.60337778 0 0 0 93.20675555-0.58254222l-1.81235358-292.56564938H763.78769383v163.5131291l-1.98064356-0.42719764c-1.68289975-0.38836148-3.37874489-0.75083219-5.07459002-1.10035753q-2.13598815-0.46603378-4.2719763-0.89323141c-1.70879052-0.33657995-3.41758103-0.64726914-5.17815309-0.95795832l-4.28492168-0.76377758a388.74984297 388.74984297 0 0 0-5.17815308-0.8155591l-4.27197629-0.64726914c-1.76057205-0.24596227-3.53408948-0.45308839-5.29466154-0.6731599-1.41104672-0.18123536-2.80914805-0.36247072-4.22019477-0.51781531-1.82529897-0.20712613-3.63765253-0.3754161-5.4629515-0.54370607-1.37221057-0.12945383-2.73147575-0.27185303-4.10368631-0.3883615-1.91591664-0.15534459-3.88361482-0.28479842-5.76069532-0.40130686-1.29453827-0.09061769-2.58907653-0.19418075-3.88361482-0.25890764-2.13598815-0.12945383-4.28492169-0.19418075-6.47269136-0.27185305-1.08741215 0-2.14893353-0.10356306-3.23634567-0.12945383q-4.84157314-0.12945383-9.70903704-0.1423992c-4.68622853 0-9.34656631 0.09061769-14.00690409 0.27185303s-9.2947848 0.46603378-13.90334104 0.82850449q-3.46936257 0.28479842-6.91283438 0.62137838a340.03636781 340.03636781 0 0 0-171.15090488 66.88879249c-2.38195042 1.78646282-4.75095547 3.62470717-7.09406973 5.48884227l-1.77351744 1.41104672c-2.25249659 1.81235358-4.47910242 3.63765253-6.67981747 5.50178765l-0.25890765 0.2200715c-2.26544197 1.91591664-4.50499318 3.88361482-6.71865363 5.86425838l-1.69584514 1.54050055q-3.13278261 2.82209343-6.16200218 5.70891377l-0.44014302 0.41425225c-2.13598815 2.04537047-4.24608553 4.12957709-6.34323752 6.22672909l-1.46282825 1.63111823c-1.90297125 1.9547528-3.80594252 3.88361482-5.65713224 5.9030945l-0.58254223 0.608433c-2.0194797 2.1748243-4.00012325 4.36259397-5.95487606 6.58919979-0.50486992 0.55665147-0.99679447 1.1262483-1.488719 1.69584514-1.76057205 2.0194797-3.50819872 4.0519048-5.17815308 6.11022063l-0.66021453 0.77672297q-2.80914805 3.41758103-5.55356917 6.899889l-1.38515595 1.77351742q-2.40784118 3.11983724-4.76390085 6.291456l-0.71199605 0.94501294c-1.73468128 2.36900503-3.44347181 4.77684622-5.17815308 7.19763279l-1.29453829 1.82529896c-1.47577363 2.13598815-2.91271111 4.29786706-4.3367032 6.47269136l-0.73788681 1.11330292c-1.59228208 2.45962272-3.15867339 4.95808158-4.69917393 7.45654044l-1.13919368 1.89002587c-1.29453827 2.18776969-2.58907653 4.38848475-3.88361481 6.60214519-0.23301689 0.42719763-0.49192453 0.84144987-0.73788682 1.29453828q-2.1748243 3.88361482-4.24608553 7.76722963c-0.34952533 0.64726914-0.68610528 1.29453827-1.02268523 1.9418074-1.17802983 2.22660583-2.34311427 4.46615703-3.46936257 6.71865363-0.16828997 0.34952533-0.36247072 0.68610528-0.5307607 1.03563062l-0.98384908-0.36247071c-1.29453827-0.47897917-2.48551348-0.95795831-3.72827022-1.41104672l-1.66995437-0.62137837c-1.77351743-0.64726914-3.53408948-1.29453827-5.3205523-1.86413512l-0.54370608-0.18123534c-1.60522747-0.54370608-3.2234003-1.07446676-4.85451851-1.57933671l-1.78646282-0.55665145c-1.29453827-0.38836148-2.49845886-0.76377758-3.75416098-1.12624829-0.63432375-0.18123536-1.29453827-0.3754161-1.89002587-0.54370607-1.37221057-0.40130686-2.75736652-0.77672297-4.14252249-1.15213907l-1.35926517-0.36247071c-1.81235358-0.46603378-3.62470717-0.91912217-5.45000612-1.29453828l-1.50166441-0.34952533-4.07779555-0.91912217-1.94180741-0.40130686-3.88361481-0.78966836-1.78646281-0.33657994c-1.85118973-0.34952533-3.70237947-0.68610528-5.56651456-0.98384909l-0.37541611-0.06472691c-1.74762667-0.28479842-3.49525333-0.54370608-5.25582539-0.80261373l-1.82529895-0.24596227-3.96128711-0.50486993-1.92886203-0.23301689c-1.44988286-0.16828997-2.89976573-0.31068918-4.3496486-0.45308839l-1.37221056-0.14239921q-2.83503882-0.24596227-5.67007763-0.46603378l-1.41104672-0.09061768c-1.46282825-0.09061769-2.91271111-0.18123536-4.37553935-0.24596227l-1.91591665-0.09061769c-1.35926518 0-2.73147575-0.10356306-4.09074094-0.1423992h-1.77351743c-1.91591664 0-3.88361482-0.06472691-5.77364069-0.06472691a269.71704889 269.71704889 0 0 0-262.90777758 209.30094775 62.94045076 62.94045076 0 0 0 61.42584099 76.8437918h716.24213491a63.04401383 63.04401383 0 0 0 62.96634154-62.97928691V306.90630163a63.04401383 63.04401383 0 0 0-62.96634154-62.97928691z m-673.9366242 613.88299378a175.39699042 175.39699042 0 0 1 159.22820741-99.95129997c1.92886203 0 3.88361482 0 5.76069531 0.10356308h1.52755516c1.68289975 0.0776723 3.3657995 0.16828997 5.03575388 0.28479842h0.76377757c1.89002587 0.1423992 3.76710637 0.32363457 5.64418687 0.5178153l1.46282825 0.16828998c1.56639131 0.16828997 3.11983724 0.3754161 4.67328315 0.5954876l1.15213906 0.15534459c1.85118973 0.27185303 3.70237947 0.58254222 5.54062382 0.9061768l1.29453826 0.25890765c1.50166439 0.28479842 3.01627417 0.58254222 4.51793858 0.9061768l1.29453827 0.29774378c1.82529897 0.40130686 3.63765253 0.84144987 5.45000612 1.29453829l1.07446677 0.28479842c1.51460978 0.40130686 3.01627417 0.81555911 4.53088395 1.29453826l1.42399209 0.42719764c1.78646282 0.54370608 3.57292563 1.11330291 5.34644307 1.70879051l0.62137837 0.22007152q2.40784118 0.81555911 4.77684622 1.70879052l1.4110467 0.53076068c1.7217359 0.6731599 3.43052642 1.29453827 5.1781531 2.07126124h0.12945384l-0.11650845 0.72494142c-0.38836148 2.11009739-0.76377758 4.22019476-1.11330292 6.33029215-0.12945383 0.77672297-0.24596227 1.55344592-0.36247071 2.31722351-0.27185303 1.66995437-0.51781531 3.32696336-0.76377758 4.99691773l-0.34952534 2.51140425c-0.23301689 1.70879052-0.45308839 3.41758103-0.64726914 5.17815308-0.09061769 0.72494143-0.19418075 1.44988286-0.27185303 2.18776968-0.27185303 2.40784118-0.53076069 4.82862775-0.7508322 7.24941432v0.58254222c-0.20712613 2.22660583-0.38836148 4.46615703-0.54370607 6.69276286l-0.1553446 2.35605967c-0.10356306 1.66995437-0.20712613 3.35285413-0.28479841 5.03575387l-0.11650845 2.58907654c-0.0776723 1.69584514-0.12945383 3.39169027-0.18123537 5.10048079 0 0.76377758 0 1.52755517-0.0647269 2.29133275q-0.0776723 3.67648869-0.0776723 7.340032V842.2237677c0 1.20392059 0 2.40784118 0.09061769 3.62470716l0.07767228 2.097152c0 1.08741215 0.0776723 2.18776969 0.12945384 3.27518183l0.11650844 2.23955121c0 1.048576 0.11650845 2.097152 0.18123536 3.145728 0 0.36247072 0 0.73788682 0.06472691 1.11330292z m380.21883576 0h-63.98902677v-0.29774381c0-0.41425225 0-0.8285045-0.09061767-1.29453827-0.15534459-1.81235358-0.28479842-3.62470717-0.40130687-5.43706073l-0.11650845-2.16187893c-0.09061769-1.59228208-0.15534459-3.19750953-0.2200715-4.78979159 0-0.68610528 0-1.29453827-0.06472691-2.04537048 0-2.22660583-0.09061769-4.44026627-0.09061769-6.6668721q0-11.76735289 1.07446676-23.40525195a249.62581491 249.62581491 0 0 1 9.91616317-50.20219417c32.46701985-105.63432297 128.5994319-176.61385639 239.2306726-176.61385639 2.05831585 0 4.1166317 0 6.16200217 0.07767229h1.77351744c1.56639131 0 3.13278261 0.11650845 4.68622853 0.19418074l1.64406361 0.0776723c2.0194797 0.11650845 4.0519048 0.24596227 6.07138448 0.40130686l0.94501294 0.09061768c1.73468128 0.1423992 3.45641718 0.31068918 5.1781531 0.47897916l1.81235357 0.20712613c1.59228208 0.16828997 3.18456415 0.36247072 4.76390084 0.56959684l1.37221057 0.18123535c1.99358894 0.27185303 3.9742325 0.56959683 5.96782143 0.8932314l1.29453827 0.2330169c1.57933669 0.25890765 3.145728 0.53076069 4.71211932 0.82850449l1.76057204 0.33657995a616.20021728 616.20021728 0 0 1 5.17815309 1.048576l0.85439527 0.18123536c1.96769817 0.44014302 3.88361482 0.9061768 5.89014912 1.38515595l1.54050055 0.38836149c1.50166439 0.3754161 3.0033288 0.77672297 4.50499319 1.1909752l1.64406359 0.4530884c3.53408948 0.98384909 7.04228819 2.07126124 10.52459616 3.22340029v260.47404564z" fill="#0e0e0e" p-id="1428"></path><path d="M292.60165373 527.9487115a46.60337778 46.60337778 0 0 0 0-93.20675555h-62.62976158a46.60337778 46.60337778 0 1 0 0 93.20675555zM951.41807091 72.99618133h-721.44617876a46.60337778 46.60337778 0 0 0 0 93.20675556h691.28343703v228.66724029a46.60337778 46.60337778 0 1 0 93.20675557 0v-258.90765432a63.04401383 63.04401383 0 0 0-63.04401384-62.96634153z" fill="#0e0e0e" p-id="1429"></path></svg>');
	
	editor.ui.registry.addButton('axupimgs', {
		icon: 'axupimgs',
        tooltip: pluginName,
		onAction: function() {
			openDialog();
		}
	});
	editor.ui.registry.addMenuItem('axupimgs', {
		icon: 'axupimgs',
		text: '图片批量上传...',
		onAction: function() {
			openDialog();
		}
	});
	return {
		getMetadata: function() {
			return  {
				name: pluginName,
				url: "http://tinymce.ax-z.cn/more-plugins/axupimgs.php",
			};
		}
	};
});
